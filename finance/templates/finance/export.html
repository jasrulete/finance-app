{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Export</title>

    <link rel="stylesheet" href="{% static 'css/export.css' %}" />
    <link rel="stylesheet" href="{% static 'css/colors.css' %}" />
    <link
      href="https://fonts.googleapis.com/css2?family=K2D:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
  </head>
  <body>
    <header class="header" role="banner">
      <a href="{% url 'dashboard' %}">
        <div class="logo">
          <div class="logo-icon">
            <img
              src="{% static 'pics/mockLogo.png' %}"
              alt="BudgetWise Logo"
              class="logo-img"
            />
          </div>
          <div class="logo-text">BudgetWise</div>
        </div>
      </a>
      <div class="user-profile">
        <div class="user-avatar">
          <img
            src="{% static 'pics/user1.png' %}"
            alt="User Avatar"
            class="avatar-image"
          />
        </div>
        <div class="user-info">
          <span class="user-name">{{ user.username }}</span>
          <a class="btn btn-outline-light ms-2" href="{% url 'logout' %}"
            >Logout</a
          >
        </div>
      </div>
    </header>

    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <a href="{% url 'dashboard' %}">
                <div class="menu-item">
                <span class="material-icons">dashboard</span><span>Dashboard</span>
                </div>
            </a>
            <a href="{% url 'finance:expenses-page' %}">
              <div class="menu-item ">
                <span class="material-icons">payments</span><span>Expenses</span>
              </div>
            </a>
            <a href="{% url 'finance:entry-list' %}">
              <div class="menu-item">
                <span class="material-icons">work_history</span>
                <span>Transactions</span>
              </div>
            </a>
            <a href="{% url 'finance:entry-export' %}">
            <div class="menu-item active">
                <span class="material-icons">file_download</span><span>Export</span>
            </div>
            </a>
        </aside>

      <!-- Main Content -->
      <div class="main-content">
        <div class="welcome-message">
          <h1>Export</h1>
          <p>Download your transaction history as a CSV file. Filter by date or category to get exactly what you need.</p>
        </div>
  
        <div class="export-card">
            {% if error %}
            <p style="color: red;">{{ error }}</p>
            {% endif %}
          <form method="POST">
            {% csrf_token %}
            <label class= "label">File Name</label>
            <input type="text" name="filename" placeholder="e.g. my_transactions" />
  
            <label class= "label">Date Range</label>
            <div class="date-range">
              <input type="date" name="start_date" />
              <span>to</span>
              <input type="date" name="end_date" />
            </div>
  
            <label class= "label">Type</label>
            <div class="type-buttons">
              <input type="radio" name="entry_type" value="income" id="income" /><label for="income">Income</label>
              <input type="radio" name="entry_type" value="expense" id="expense" /><label for="expense">Expense</label>
              <input type="radio" name="entry_type" value="" id="all" checked /><label for="all">All</label>
            </div>
  
            <label class= "label">Category</label>
            <select name="category" id="category-select">
              <option value="">Select Category</option>
              {% for cat in categories %}
                <option value="{{ cat.id }}">{{ cat.name }}</option>
              {% endfor %}
            </select>
  
            <button type="submit" class="export-btn">Export</button>
          </form>
        </div>
    </div>
    <script>
        const startInput = document.querySelector('input[name="start_date"]');
        const endInput = document.querySelector('input[name="end_date"]');
        
        function validateDates() {
            if (startInput.value && endInput.value && endInput.value < startInput.value) {
            alert("End date cannot be earlier than start date.");
            endInput.value = "";
            }
        }
        
        startInput.addEventListener("change", validateDates);
        endInput.addEventListener("change", validateDates);
    </script>
    <script>
      // Dynamic category filtering based on entry type
      document.querySelectorAll('input[name="entry_type"]').forEach((radio) => {
        radio.addEventListener("change", function () {
          const entryType = this.value;
          const categorySelect = document.getElementById("category-select");
    
          // Fetch filtered categories
          fetch(`/finance/get-categories/?entry_type=${entryType}`)
            .then((response) => response.json())
            .then((data) => {
              // Clear existing options
              categorySelect.innerHTML = '<option value="">Select Category</option>';
    
              // Populate new filtered categories
              data.categories.forEach((cat) => {
                const option = document.createElement("option");
                option.value = cat.id;
                option.textContent = cat.name;
                categorySelect.appendChild(option);
              });
            });
        });
      });
    </script>
  </body>
</html>
